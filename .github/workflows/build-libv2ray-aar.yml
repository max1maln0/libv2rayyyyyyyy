name: Build libv2ray.aar (no-xudp friendly)

on:
  workflow_dispatch:
    inputs:
      core_repo:
        description: 'Git URL AndroidLibXrayLite (или ваш форк)'
        required: false
        default: 'https://github.com/2dust/AndroidLibXrayLite.git'
      core_ref:
        description: 'Git ref/branch/tag (пусто = дефолтная ветка)'
        required: false
        default: ''
  push:
    tags:
      - 'libv2ray-*'

permissions:
  contents: read

env:
  ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
  ANDROID_HOME:     ${{ github.workspace }}/android-sdk
  ANDROID_NDK_VERSION: '26.3.11579264'
  GO_VERSION: '1.22.x'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo (workflow)
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install Android SDK / NDK (cmdline-tools)
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends unzip libc6 libstdc++6 ca-certificates

          mkdir -p "${ANDROID_SDK_ROOT}/cmdline-tools"
          cd "${ANDROID_SDK_ROOT}/cmdline-tools"
          curl -fsSL https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o cmd.zip
          unzip -q cmd.zip
          rm -f cmd.zip
          mv cmdline-tools latest

          # Лицензии: возможен Broken pipe — игнорируем и идём дальше
          yes | "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" --licenses || true

          "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "ndk;${ANDROID_NDK_VERSION}"

          echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/${ANDROID_NDK_VERSION}" >> "$GITHUB_ENV"
          echo "${ANDROID_SDK_ROOT}/platform-tools" >> $GITHUB_PATH
          echo "${ANDROID_SDK_ROOT}/build-tools/34.0.0" >> $GITHUB_PATH

      - name: Install gomobile/gobind
        shell: bash
        run: |
          set -euxo pipefail
          go env -w GOPROXY=https://proxy.golang.org,direct
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          # Прогреем сам пакет, который использует gomobile bind
          go get golang.org/x/mobile/bind@latest || true
          "${HOME}/go/bin/gomobile" version || true

      - name: Install dos2unix (optional)
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update -y
          sudo apt-get install -y dos2unix

      - name: Clone AndroidLibXrayLite
        shell: bash
        run: |
          set -euxo pipefail
          REPO_URL="${{ github.event.inputs.core_repo }}"
          REF="${{ github.event.inputs.core_ref }}"
          : "${REPO_URL:=https://github.com/2dust/AndroidLibXrayLite.git}"
          : "${REF:=}"
          echo "[clone] ${REPO_URL} ${REF:+@ $REF}"
          if [[ -z "$REF" ]]; then
            git clone --depth=1 "${REPO_URL}" AndroidLibXrayLite
          else
            git clone --depth=1 --branch "$REF" "${REPO_URL}" AndroidLibXrayLite
          fi

      - name: Create & stage patch (disable XUDP) — optional
        shell: bash
        continue-on-error: true
        run: |
          set -euxo pipefail
          if [[ -f scripts/disable_xudp.sh ]]; then
            dos2unix scripts/disable_xudp.sh || true
            bash scripts/disable_xudp.sh AndroidLibXrayLite
          else
            echo "No disable_xudp.sh — skip"
          fi

      - name: gomobile init
        shell: bash
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        run: |
          set -euxo pipefail
          "${HOME}/go/bin/gomobile" init

      - name: Build AAR (arm64 only)
        shell: bash
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        run: |
          set -euxo pipefail
          echo "==== go env ===="
          go env

          # 1) Выбираем корректный пакет для bind
          MOBILE_DIR=""
          if [[ -d AndroidLibXrayLite/mobile ]]; then
            MOBILE_DIR="AndroidLibXrayLite/mobile"
          else
            # фоллбек: поиск файлов с `package mobile`
            found="$(grep -RIl --include='*.go' '^package[[:space:]]\+mobile$' AndroidLibXrayLite || true)"
            if [[ -n "$found" ]]; then
              MOBILE_DIR="$(dirname "$(echo "$found" | head -n1)")"
            fi
          fi

          if [[ -z "${MOBILE_DIR}" ]]; then
            echo "::error::Не найден пакет 'mobile' в AndroidLibXrayLite (ни папки mobile/, ни package mobile)."
            exit 1
          fi

          echo "Using package: ${MOBILE_DIR}"

          # 2) Подтягиваем зависимости и прогреваем bind-пакет
          pushd "${MOBILE_DIR}"
            go mod download || true
          popd
          go get golang.org/x/mobile/bind@latest || true

          # 3) Сборка AAR
          "${HOME}/go/bin/gomobile" bind -v \
            -target=android/arm64 \
            -androidapi=24 \
            -o libv2ray.aar \
            "${MOBILE_DIR}" 2>&1 | tee build.log

          test -f libv2ray.aar || { echo "::error::gomobile bind не создал libv2ray.aar"; exit 1; }

      - name: Upload build log (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          if-no-files-found: ignore

      - name: Upload artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: libv2ray-aar
          path: libv2ray.aar
