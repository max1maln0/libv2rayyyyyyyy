name: build-libv2ray-aar

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo (workflow)
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Install Android SDK / NDK (cmdline-tools)
        uses: android-actions/setup-android@v3

      - name: Install required Android packages
        shell: bash
        run: |
          set -euo pipefail
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "ndk;26.3.11579264" >/dev/null
          # иногда sdkmanager завершает раньше 'yes', поэтому не валим билд
          yes | sdkmanager --licenses || true
          echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/26.3.11579264" >> $GITHUB_ENV

      - name: Install gomobile/gobind
        shell: bash
        run: |
          set -euo pipefail
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          gomobile version || true

      - name: Install dos2unix
        run: sudo apt-get update && sudo apt-get install -y dos2unix

      - name: Clone AndroidLibXrayLite
        shell: bash
        run: |
          set -euo pipefail
          # Берём дефолтную ветку (без принудительного master)
          git clone --depth=1 https://github.com/2dust/AndroidLibXrayLite.git

      - name: Create & apply XUDP patch
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p scripts
          cat > scripts/disable_xudp.sh <<'BASH'
          #!/usr/bin/env bash
          set -euo pipefail

          CORE_DIR="${1:-${GITHUB_WORKSPACE:-.}/AndroidLibXrayLite}"
          echo "[xudp] core dir: ${CORE_DIR}"

          if [[ ! -d "$CORE_DIR" ]]; then
            echo "::warning::Core dir not found: ${CORE_DIR}. Skip patch."
            exit 0
          fi

          mapfile -t CANDIDATES < <(grep -RIl --include='*.go' -e 'xray\.xudp\.basekey' -e 'xray\.xudp' "${CORE_DIR}" || true)
          if [[ "${#CANDIDATES[@]}" -eq 0 ]]; then
            echo "::warning::No xudp usages found."
            exit 0
          fi

          patch_file () {
            local f="$1"
            cp -f "$f" "$f.bak"
            # XUDP всегда off
            sed -i -e 's/os\.Getenv\s*(\s*"xray\.xudp"\s*)/"off"/g' -e 's/Getenv\s*(\s*"xray\.xudp"\s*)/"off"/g' "$f"
            # basekey всегда пустой
            sed -i -e 's/os\.Getenv\s*(\s*"xray\.xudp\.basekey"\s*)/""/g' -e 's/Getenv\s*(\s*"xray\.xudp\.basekey"\s*)/""/g' "$f"
            # убираем panics по basekey
            sed -i -e 's/panic\s*(.*xray\.xudp\.basekey.*)/log.Print("XUDP disabled (panic removed)"); return/g' "$f"
            # проверки длины ключа делаем недостижимыми
            sed -i -e 's/len\s*(\s*[^)]\+)\s*!=\s*32/false/g' "$f"
          }

          for f in "${CANDIDATES[@]}"; do
            echo "[xudp] patching: $f"
            patch_file "$f"
          done

          echo "[xudp] patch done"
          BASH

          chmod +x scripts/disable_xudp.sh
          dos2unix scripts/disable_xudp.sh || true
          ./scripts/disable_xudp.sh "${GITHUB_WORKSPACE}/AndroidLibXrayLite"

      - name: gomobile init
        shell: bash
        run: |
          set -euo pipefail
          export ANDROID_HOME="${ANDROID_SDK_ROOT}"
          export ANDROID_NDK_HOME="${ANDROID_NDK_HOME}"
          gomobile init -ndk "${ANDROID_NDK_HOME}"

      - name: Build AAR (arm64 only)
        shell: bash
        run: |
          set -euo pipefail
          export ANDROID_HOME="${ANDROID_SDK_ROOT}"
          export ANDROID_NDK_HOME="${ANDROID_NDK_HOME}"
          # В AndroidLibXrayLite java-пакет лежит в каталоге 'mobile'
          pushd AndroidLibXrayLite/mobile >/dev/null
          # Ставим минимальный api у выходного .aar
          gomobile bind -v -target=android/arm64 -androidapi=24 -o "${GITHUB_WORKSPACE}/libv2ray.aar" .
          popd >/dev/null

      - name: Verify .aar
        shell: bash
        run: |
          set -euo pipefail
          ls -l libv2ray.aar
          unzip -l libv2ray.aar | sed -n '1,80p'

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libv2ray-aar
          path: libv2ray.aar
